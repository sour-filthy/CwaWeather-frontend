<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taiwan Weather Whack-a-Mole</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ¤ï¸</text></svg>">

    <style>
        :root {
            --hole-color: #3e2723;
            --mole-color: #8d6e63;
            --mole-bonked: #e53935;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            background-color: #87CEEB;
        }

        h1 {
            color: #fff;
            text-shadow: 2px 2px 0 #333;
            margin-top: 20px;
            margin-bottom: 5px;
            z-index: 10;
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .subtitle {
            color: #fff;
            text-shadow: 2px 2px 0 #333;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 20px;
            z-index: 10;
            text-align: center;
            letter-spacing: 1px;
        }

        /* --- åœ°åœ–å®¹å™¨ --- */
        .map-container {
            position: relative;
            width: 95%;
            max-width: 600px;
            /* é«˜åº¦æœƒç”± JS å‹•æ…‹èª¿æ•´ï¼Œé€™è£¡è¨­ä¸€å€‹æœ€å°é«˜åº¦ */
            min-height: 600px; 
            margin-bottom: 50px;
        }

        /* --- SVG åœ°åœ–æ¨£å¼ --- */
        svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .map-path {
            fill: rgba(255, 255, 255, 0.4);
            stroke: rgba(255, 255, 255, 0.9);
            stroke-width: 1px;
            /* vector-effect è®“é‚Šæ¡†åœ¨ç¸®æ”¾æ™‚ä¿æŒç´°ç·»ï¼Œä¸æœƒè®Šç²— */
            vector-effect: non-scaling-stroke; 
            transition: fill 0.3s;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
        }
        
        /* å¢åŠ ä¸€å€‹ hover æ•ˆæœè®“åœ°åœ–æ›´æœ‰äº’å‹•æ„Ÿ */
        .map-path:hover {
            fill: rgba(255, 255, 255, 0.6);
        }

        /* --- æ´èˆ‡åœ°é¼ æ¨£å¼ (ä¿æŒä¸è®Š) --- */
        .hole-container {
            position: absolute;
            width: 50px;
            height: 50px;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 1;
        }
        .hole-container.active { z-index: 1000; }

        .hole {
            width: 100%; height: 16px; background: var(--hole-color);
            border-radius: 50%; position: absolute; bottom: 12px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.5) inset; z-index: 1; 
        }

        .city-label {
            position: absolute; top: 6px; width: 80px; left: 50%;
            transform: translateX(-50%); text-align: center; color: #fff;
            font-weight: bold; font-size: 12px; text-shadow: 1px 1px 0 #000, -1px -1px 0 #000;
            pointer-events: none; z-index: 3;
        }

        .mole {
            width: 36px; height: 42px; background: var(--mole-color);
            border-radius: 18px 18px 8px 8px; position: absolute;
            bottom: 18px; left: 50%; transform: translateX(-50%) scale(0.1);
            opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2; display: flex; justify-content: center;
        }
        .mole::before { content: ''; width: 12px; height: 8px; background: #d7ccc8; border-radius: 50%; position: absolute; top: 18px; }
        .mole::after { content: ''; width: 4px; height: 4px; background: #333; border-radius: 50%; position: absolute; top: 14px; left: 10px; box-shadow: 12px 0 0 #333; }
        
        .mole.bonked { background: var(--mole-bonked); }
        .mole.bonked::after {
            content: 'x x'; background: transparent; box-shadow: none;
            font-size: 12px; font-weight: bold; top: 12px; left: 50%;
            transform: translateX(-50%); color: #fff; letter-spacing: 2px;
        }
        .hole-container.active .mole.bonked { transform: translateX(-50%) rotate(25deg) translateY(5px); transition: transform 0.1s; }

        .mole-info {
            background: white; padding: 4px 6px; border-radius: 6px;
            text-align: center; font-size: 11px; border: 2px solid #333;
            position: absolute; top: -65px; width: 85px; left: 50%;
            transform: translateX(-50%) scale(0.8); opacity: 0;
            pointer-events: none; transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .mole-info strong { color: #d84315; font-size: 1.1em; display: block; margin-bottom: 2px;}
        .hole-container.active .mole { transform: translateX(-50%) scale(1); opacity: 1; }
        .hole-container.active .mole-info { opacity: 1; transform: translateX(-50%) scale(1); }

        #loading { color: white; font-size: 1.5em; text-shadow: 1px 1px 2px #333; position: absolute; top: 50%; }

        @media (max-width: 600px) {
            .hole-container { width: 30px; height: 30px; }
            .hole { height: 10px; bottom: 8px; }
            .city-label { font-size: 10px; top: 4px; }
            .mole { width: 24px; height: 30px; bottom: 12px; }
            .mole::before { width: 8px; height: 6px; top: 12px; }
            .mole::after { width: 3px; height: 3px; top: 10px; left: 6px; box-shadow: 9px 0 0 #333; }
        }
    </style>
</head>
<body>

    <h1>ğŸŒ§ï¸ Weather Whack-a-Mole ğŸŒ¤ï¸</h1>
    <div class="subtitle">è«‹é»é¸æ‰€åœ¨åŸå¸‚</div>
    
    <div id="loading">Scouting for moles...</div>
    
    <div id="game-board" class="map-container">
        </div>

    <script>
        // âš ï¸ ç¢ºèª Zeabur ç¶²å€
        const API_URL = 'https://hex-final.zeabur.app/api/weather'; 
        
        const board = document.getElementById('game-board');
        const loading = document.getElementById('loading');
        
        let citiesData = [];
        let geoData = null;
        let autoPlayTimeout = null;
        let pathElements = {}; // å„²å­˜åœ°åœ–è·¯å¾‘å…ƒç´ ä»¥ä¾¿å¾ŒçºŒæ“ä½œ

        // 1. åˆå§‹åŒ–ï¼šåŒæ™‚è¼‰å…¥å¤©æ°£è³‡æ–™å’Œåœ°åœ–è³‡æ–™
        async function init() {
            try {
                // å¹³è¡Œè¼‰å…¥å…©ä»½è³‡æ–™ï¼ŒåŠ å¿«é€Ÿåº¦
                const [weatherRes, mapRes] = await Promise.all([
                    fetch(API_URL),
                    fetch('tw.json') // è®€å–ä½ æ”¾åœ¨ public è³‡æ–™å¤¾çš„æª”æ¡ˆ
                ]);

                const weatherJson = await weatherRes.json();
                geoData = await mapRes.json();

                if (weatherJson.success) {
                    citiesData = weatherJson.data;
                    drawMapSystem(); // å•Ÿå‹•ç¹ªåœ–ç³»çµ±
                    loading.style.display = 'none';
                }
            } catch (err) {
                loading.innerText = "Error: ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¢ºèª tw.json æ˜¯å¦åœ¨ public è³‡æ–™å¤¾";
                console.error(err);
            }
        }

        // 2. ç¹ªåœ–ç³»çµ±æ ¸å¿ƒ
        function drawMapSystem() {
            board.innerHTML = ''; // æ¸…ç©ºç•«å¸ƒ

            // --- A. è¨ˆç®—åœ°åœ–é‚Šç•Œ (Bounding Box) ---
            // ç‚ºäº†æŠŠåœ°åœ–å®Œç¾å¡é€²ç•«å¸ƒï¼Œæˆ‘å€‘éœ€è¦çŸ¥é“æœ€æ±å—è¥¿åŒ—çš„åº§æ¨™
            let bounds = { minX: Infinity, minY: Infinity, maxX: -Infinity, maxY: -Infinity };
            
            geoData.features.forEach(feature => {
                // è™•ç†ä¸åŒé¡å‹çš„å¹¾ä½•å½¢ç‹€ (Polygon å’Œ MultiPolygon)
                const geometry = feature.geometry;
                const coords = geometry.type === 'MultiPolygon' 
                    ? geometry.coordinates.flat(1) 
                    : geometry.coordinates;

                coords.forEach(ring => {
                    ring.forEach(([x, y]) => {
                        if (x < bounds.minX) bounds.minX = x;
                        if (x > bounds.maxX) bounds.maxX = x;
                        if (y < bounds.minY) bounds.minY = y;
                        if (y > bounds.maxY) bounds.maxY = y;
                    });
                });
            });

            // --- B. å»ºç«‹ SVG ---
            // ä½¿ç”¨ viewBox è®“ SVG è‡ªå‹•ç¸®æ”¾
            // ç‚ºäº†è®“åœ°åœ–ä¸è¦è²¼é‚Šï¼Œæˆ‘å€‘ç•™ä¸€é» padding (é‚Šè·)
            const padding = 0.2; // ç¶“ç·¯åº¦å–®ä½çš„ç•™ç™½
            const viewBox = `${bounds.minX - padding} ${bounds.minY - padding} ${bounds.maxX - bounds.minX + padding*2} ${bounds.maxY - bounds.minY + padding*2}`;
            
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            // æ³¨æ„ï¼šSVG çš„ Y è»¸æ˜¯å‘ä¸‹çš„ï¼Œä½†ç¶“ç·¯åº¦çš„ Y (ç·¯åº¦) æ˜¯å‘ä¸Šçš„
            // é€™è£¡æˆ‘å€‘ç”¨ CSS transform æˆ–è€…åœ¨ pathç”Ÿæˆæ™‚ç¿»è½‰ï¼Œæœ€ç°¡å–®æ˜¯ç”¨ scale(1, -1)
            svg.setAttribute("viewBox", viewBox);
            svg.style.transform = "scaleY(-1)"; // ç¿»è½‰ Y è»¸è®“åœ°åœ–è½‰æ­£
            board.appendChild(svg);

            // --- C. ç¹ªè£½æ¯ä¸€å€‹ç¸£å¸‚ ---
            geoData.features.forEach(feature => {
                const pathData = generatePath(feature.geometry);
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", pathData);
                path.setAttribute("class", "map-path");
                
                // å˜—è©¦å¾å±¬æ€§ä¸­æŠ“å–ç¸£å¸‚åç¨± (ç›¸å®¹å¸¸è¦‹æ ¼å¼)
                const props = feature.properties;
                const name = props.COUNTYNAME || props.name || props.Name || props.C_Name || "";
                
                path.id = `map-${name}`; // çµ¦å€‹ ID æ–¹ä¾¿é™¤éŒ¯
                svg.appendChild(path);

                // --- D. è‡ªå‹•è¨ˆç®—åœ°é¼ æ´ä½ç½® (é‡å¿ƒ Centroid) ---
                if (name) {
                    const center = calculateCentroid(feature.geometry);
                    // å› ç‚ºæˆ‘å€‘ç¿»è½‰äº† SVGï¼Œä½† HTML çš„ div æ²’ç¿»è½‰ï¼Œæ‰€ä»¥è¦è¨ˆç®— HTML çš„ % ä½ç½®
                    // é€™æœ‰é»è¤‡é›œï¼Œæ‰€ä»¥æˆ‘å€‘ç”¨ä¸€å€‹æ›´è°æ˜çš„æ–¹æ³•ï¼š
                    // ç›´æ¥æŠŠåœ°é¼ æ´æ”¾é€²åœ°åœ–åº§æ¨™ç³»ï¼Ÿä¸è¡Œï¼Œå› ç‚ºåœ°é¼ åŒ…å« HTML æ–‡å­—ã€‚
                    // æˆ‘å€‘æ”¹ç”¨è¨ˆç®—ç›¸å°æ–¼ bounds çš„ç™¾åˆ†æ¯”ã€‚
                    
                    createHoleAt(name, center, bounds);
                }
            });
        }

        // è¼”åŠ©ï¼šç”Ÿæˆ SVG Path å­—ä¸²
        function generatePath(geometry) {
            let d = "";
            const coords = geometry.type === 'MultiPolygon' ? geometry.coordinates : [geometry.coordinates];
            
            coords.forEach(poly => {
                poly.forEach(ring => {
                    d += "M";
                    ring.forEach(([x, y]) => d += `${x},${y} `);
                    d += "Z ";
                });
            });
            return d;
        }

        // è¼”åŠ©ï¼šè¨ˆç®—å¹¾ä½•ä¸­å¿ƒ (ç²—ç•¥ç®—æ³•ï¼Œå–æ‰€æœ‰é»çš„å¹³å‡å€¼)
        function calculateCentroid(geometry) {
            let totalX = 0, totalY = 0, count = 0;
            const coords = geometry.type === 'MultiPolygon' ? geometry.coordinates.flat(2) : geometry.coordinates.flat(1);
            
            coords.forEach(([x, y]) => {
                totalX += x;
                totalY += y;
                count++;
            });
            return { x: totalX / count, y: totalY / count };
        }

        // è¼”åŠ©ï¼šåœ¨ç‰¹å®šåº§æ¨™å‰µé€ åœ°é¼ æ´
        function createHoleAt(cityName, center, bounds) {
            // 1. æ‰¾åˆ°å°æ‡‰çš„å¤©æ°£è³‡æ–™
            // æœ‰æ™‚å€™ geojson çš„åå­— (è‡ºåŒ—å¸‚) è·Ÿ API çš„åå­— (è‡ºåŒ—å¸‚) å¯èƒ½æœƒå·®ä¸€å€‹å­— (å°/è‡º)
            // é€™è£¡åšå€‹ç°¡å–®çš„æ¨¡ç³Šæ¯”å°
            const weatherCity = citiesData.find(c => 
                c.name === cityName || 
                c.name.replace('è‡º', 'å°') === cityName.replace('è‡º', 'å°')
            );
            
            if (!weatherCity) return; // å¦‚æœé€™å€‹åœ°åœ–å€å¡Šæ²’æœ‰å¤©æ°£è³‡æ–™å°±ä¸æŒ–æ´

            // 2. å°‡ç¶“ç·¯åº¦è½‰æ›ç‚ºå®¹å™¨çš„ç™¾åˆ†æ¯”åº§æ¨™ (Top/Left)
            // å¯¬åº¦ç¯„åœ
            const rangeX = (bounds.maxX + 0.2) - (bounds.minX - 0.2); // åŠ ä¸Š padding
            const rangeY = (bounds.maxY + 0.2) - (bounds.minY - 0.2);
            
            // è¨ˆç®—ç™¾åˆ†æ¯”
            const leftPct = ((center.x - (bounds.minX - 0.2)) / rangeX) * 100;
            const topPct = 100 - ((center.y - (bounds.minY - 0.2)) / rangeY) * 100; // Yè»¸åè½‰

            // 3. å»ºç«‹ DOM
            const container = document.createElement('div');
            container.className = 'hole-container';
            container.style.left = `${leftPct}%`;
            container.style.top = `${topPct}%`;
            
            // ç¶å®šè³‡æ–™
            const index = citiesData.indexOf(weatherCity);
            container.dataset.index = index;

            container.innerHTML = `
                <div class="mole" id="mole-${index}">
                    <div class="mole-info">
                        <strong>${weatherCity.minTemp}-${weatherCity.maxTemp}</strong>
                        <div>${weatherCity.condition}</div>
                        <div>â˜” ${parseInt(weatherCity.pop)}%</div>
                    </div>
                </div>
                <div class="hole"></div>
                <div class="city-label">${weatherCity.name}</div>
            `;

            container.addEventListener('click', (e) => {
                e.stopPropagation();
                whackMole(index);
            });

            board.appendChild(container);
        }

        // éŠæˆ²é‚è¼¯ (ä¿æŒä¸è®Š)
        function whackMole(index) {
            clearTimeout(autoPlayTimeout);
            document.querySelectorAll('.hole-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.mole').forEach(el => el.classList.remove('bonked'));

            // ä½¿ç”¨ dataset ç¢ºä¿æŠ“åˆ°æ­£ç¢ºçš„å…ƒç´ 
            const allHoles = document.querySelectorAll('.hole-container');
            const target = Array.from(allHoles).find(h => h.dataset.index == index);

            if (target) {
                const targetMole = target.querySelector('.mole');
                target.classList.add('active');
                targetMole.classList.add('bonked');
                setTimeout(() => {
                    targetMole.classList.remove('bonked');
                }, 500);
            }
        }

        function hideAllMoles() {
            const activeMoles = document.querySelectorAll('.hole-container.active');
            if (activeMoles.length > 0) {
                activeMoles.forEach(el => el.classList.remove('active'));
                autoPlayTimeout = setTimeout(showRandomMole, 1000);
            }
        }

        function showRandomMole() {
            if (citiesData.length === 0) return;
            const randomIdx = Math.floor(Math.random() * citiesData.length);
            
            document.querySelectorAll('.hole-container').forEach(el => el.classList.remove('active'));
            const allHoles = document.querySelectorAll('.hole-container');
            const target = Array.from(allHoles).find(h => h.dataset.index == randomIdx);
            
            if(target) target.classList.add('active');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.hole-container')) {
                hideAllMoles();
            }
        });

        // å•Ÿå‹•
        init();
    </script>
</body>
</html>