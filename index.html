<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taiwan Weather Whack-a-Mole</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå§Ô∏è</text></svg>">

    <style>
        :root {
            --hole-color: #3e2723;
            --mole-color: #8d6e63;
            --mole-bonked: #e53935;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            background-color: #87CEEB; /* Â§©Á©∫Ëóç */
        }

        h1 {
            color: #fff;
            text-shadow: 2px 2px 0 #333;
            margin: 20px 0;
            z-index: 10;
            text-align: center;
            font-size: 1.8rem;
        }

        /* --- Âú∞ÂúñÂÆπÂô® --- */
        .map-container {
            position: relative;
            width: 95%;
            max-width: 500px; /* ÂØ¨Â∫¶ÈôêÂà∂ */
            aspect-ratio: 0.5; /* ÈÖçÂêà SVG ÁöÑ 600:1200 ÊØî‰æã (1:2) */
            margin-bottom: 50px;
        }

        /* --- üåü ÂÖßÂµå SVG Âú∞ÂúñÊ®£Âºè --- */
        .taiwan-map-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none; /* ËÆìÈªûÊìäÁ©øÈÄè */
            /* ËÆì SVG Ëá™ÈÅ©ÊáâÂÆπÂô®Â§ßÂ∞è */
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }

        .tw-city {
            fill: rgba(255, 255, 255, 0.5); /* ÂçäÈÄèÊòéÁôΩËâ≤ */
            stroke: #fff; /* ÁôΩËâ≤ÈÇäÊ°Ü */
            stroke-width: 2;
            transition: fill 0.3s;
        }

        /* --- Ê¥û --- */
        .hole-container {
            position: absolute;
            width: 50px;
            height: 50px;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 1;
        }

        .hole-container.active { z-index: 1000; }

        .hole {
            width: 100%;
            height: 16px;
            background: var(--hole-color);
            border-radius: 50%;
            position: absolute;
            bottom: 12px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.5) inset;
            z-index: 1; 
        }

        .city-label {
            position: absolute;
            top: 6px;
            width: 80px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: #fff;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 1px 1px 0 #000, -1px -1px 0 #000;
            pointer-events: none;
            z-index: 3;
        }

        /* --- Âú∞Èº† --- */
        .mole {
            width: 36px;
            height: 42px;
            background: var(--mole-color);
            border-radius: 18px 18px 8px 8px;
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%) scale(0.1);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2;
            display: flex;
            justify-content: center;
        }

        .mole::before { /* ÈºªÂ≠ê */
            content: ''; width: 12px; height: 8px; background: #d7ccc8;
            border-radius: 50%; position: absolute; top: 18px;
        }
        .mole::after { /* ÁúºÁùõ */
            content: ''; width: 4px; height: 4px; background: #333;
            border-radius: 50%; position: absolute; top: 14px; left: 10px;
            box-shadow: 12px 0 0 #333;
        }

        /* Ë¢´ÊâìÂà∞ */
        .mole.bonked { background: var(--mole-bonked); }
        .mole.bonked::after {
            content: 'x x'; background: transparent; box-shadow: none;
            font-size: 12px; font-weight: bold; top: 12px; left: 50%;
            transform: translateX(-50%); color: #fff; letter-spacing: 2px;
        }

        .hole-container.active .mole.bonked {
            transform: translateX(-50%) rotate(25deg) translateY(5px);
            transition: transform 0.1s;
        }

        /* Ë≥áË®äÁâå */
        .mole-info {
            background: white; padding: 4px 6px; border-radius: 6px;
            text-align: center; font-size: 11px; border: 2px solid #333;
            position: absolute; top: -65px; width: 85px; left: 50%;
            transform: translateX(-50%) scale(0.8); opacity: 0;
            pointer-events: none; transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .mole-info strong { color: #d84315; font-size: 1.1em; display: block; margin-bottom: 2px;}

        .hole-container.active .mole { transform: translateX(-50%) scale(1); opacity: 1; }
        .hole-container.active .mole-info { opacity: 1; transform: translateX(-50%) scale(1); }

        #loading {
            color: white; font-size: 1.5em; text-shadow: 1px 1px 2px #333; position: absolute; top: 50%;
        }

        /* ÊâãÊ©üÁâà RWD */
        @media (max-width: 600px) {
            .hole-container { width: 30px; height: 30px; }
            .hole { height: 10px; bottom: 8px; }
            .city-label { font-size: 10px; top: 4px; }
            .mole { width: 24px; height: 30px; bottom: 12px; }
            .mole::before { width: 8px; height: 6px; top: 12px; }
            .mole::after { width: 3px; height: 3px; top: 10px; left: 6px; box-shadow: 9px 0 0 #333; }
        }
    </style>
</head>
<body>

    <h1>üåßÔ∏è Weather Whack-a-Mole üå§Ô∏è</h1>
    <div id="loading">Scouting for moles...</div>
    
    <div id="game-board" class="map-container">
        <svg viewBox="0 0 600 1200" id="twMap" class="taiwan-map-svg">
            <g>
                <path data-city="lienchiang" class="tw-city" d="M150 180 L180 190 L170 215 L140 205 Z"></path>
                <path data-city="kinmen" class="tw-city" d="M30 350 L80 360 L70 400 L20 390 Z"></path>
                <path data-city="penghu" class="tw-city" d="M35 565 L45 595 L15 605 L5 575 Z"></path>
                <path data-city="newtaipei" class="tw-city" d="M315 200 L445 240 L440 290 L380 325 L290 245 Z"></path>
                <path data-city="keelung" class="tw-city" d="M410 215 L430 230 L410 255 L390 240 Z"></path>
                <path data-city="taipei" class="tw-city" d="M370 225 L410 255 L390 280 L350 250 Z"></path>
                <path data-city="yilan" class="tw-city" d="M380 325 L440 290 L440 430 L340 430 L360 375 Z"></path>
                <path data-city="taoyuan" class="tw-city" d="M290 245 L380 325 L360 375 L265 290 Z"></path>
                <path data-city="hsinchu_county" class="tw-city" d="M265 290 L360 375 L340 430 L230 350 Z"></path>
                <path data-city="hsinchu_city" class="tw-city" d="M250 315 L270 330 L250 365 L230 350 Z"></path>
                <path data-city="miaoli" class="tw-city" d="M230 350 L340 430 L245 445 L180 430 Z"></path>
                <path data-city="taichung" class="tw-city" d="M180 430 L245 445 L340 430 L330 485 L230 500 L150 485 Z"></path>
                <path data-city="hualien" class="tw-city" d="M440 430 L400 650 L290 720 L330 485 L340 430 Z"></path>
                <path data-city="taitung" class="tw-city" d="M290 720 L400 650 L320 920 L270 830 Z"></path>
                <path data-city="nantou" class="tw-city" d="M330 485 L290 720 L270 720 L250 650 L240 580 L230 500 Z"></path>
                <path data-city="changhua" class="tw-city" d="M150 485 L230 500 L240 580 L110 560 Z"></path>
                <path data-city="yunlin" class="tw-city" d="M110 560 L240 580 L250 650 L100 630 Z"></path>
                <path data-city="chiayi_county" class="tw-city" d="M100 630 L250 650 L270 720 L250 750 L90 730 Z"></path>
                <path data-city="chiayi_city" class="tw-city" d="M170 680 L220 680 L220 700 L170 700 Z"></path>
                <path data-city="tainan" class="tw-city" d="M90 730 L250 750 L180 805 L120 840 Z"></path>
                <path data-city="kaohsiung" class="tw-city" d="M120 840 L180 805 L250 750 L270 720 L290 720 L270 830 L180 920 Z"></path>
                <path data-city="pingtung" class="tw-city" d="M180 920 L270 830 L320 920 L300 1100 L240 1080 Z"></path>
            </g>
        </svg>
    </div>

    <script>
        // ‚ö†Ô∏è Á¢∫Ë™ç Zeabur Á∂≤ÂùÄ
        const API_URL = 'https://hex-final.zeabur.app/api/weather'; 
        
        const board = document.getElementById('game-board');
        const loading = document.getElementById('loading');
        let citiesData = [];
        let autoPlayTimeout = null;

        // üó∫Ô∏è ‰æùÁÖß SVG 600x1200 Ë®àÁÆóÂá∫ÁöÑÁ≤æÊ∫ñÂ∫ßÊ®ô
        // ÁÆóÊ≥ïÔºöLeft% = (x/600)*100, Top% = (y/1200)*100
        const coordinates = {
            "ÈÄ£Ê±üÁ∏£": { t: 16.6, l: 26.6 },  // Matsu
            "ÈáëÈñÄÁ∏£": { t: 31.2, l: 8.3 },   // Kinmen
            "ÊæéÊπñÁ∏£": { t: 49.0, l: 4.1 },   // Penghu (‰øÆÊ≠£ÊúÄÂ∑¶ÈÇä)
            "Âü∫ÈöÜÂ∏Ç": { t: 19.5, l: 70.0 },  // Keelung (Âè≥‰∏äËßí)
            "Ëá∫ÂåóÂ∏Ç": { t: 21.0, l: 65.0 },  // Taipei (ÁõÜÂú∞‰∏≠ÂøÉ)
            "Êñ∞ÂåóÂ∏Ç": { t: 25.0, l: 58.0 },  // New Taipei (Á®çÂæÆÂæÄÂ∑¶‰∏ãÂåÖÂúçÂè∞Âåó)
            "Ê°ÉÂúíÂ∏Ç": { t: 26.0, l: 50.0 },  // Taoyuan
            "Êñ∞Á´πÁ∏£": { t: 30.0, l: 52.0 },  // Hsinchu County
            "Êñ∞Á´πÂ∏Ç": { t: 28.0, l: 42.0 },  // Hsinchu City (Â∞èÈªû)
            "ËãóÊ†óÁ∏£": { t: 33.0, l: 41.0 },
            "Ëá∫‰∏≠Â∏Ç": { t: 39.0, l: 41.0 },
            "ÂΩ∞ÂåñÁ∏£": { t: 44.0, l: 30.0 },
            "ÂçóÊäïÁ∏£": { t: 50.0, l: 46.0 },
            "Èõ≤ÊûóÁ∏£": { t: 50.0, l: 30.0 },
            "ÂòâÁæ©Â∏Ç": { t: 57.5, l: 32.5 },
            "ÂòâÁæ©Á∏£": { t: 56.0, l: 42.0 },  // Á®çÂæÆÂæÄÂè≥ÈåØÈñãÂ∏ÇÂçÄ
            "Ëá∫ÂçóÂ∏Ç": { t: 65.0, l: 30.0 },
            "È´òÈõÑÂ∏Ç": { t: 68.0, l: 35.0 },
            "Â±èÊù±Á∏£": { t: 79.0, l: 43.0 },
            "ÂÆúËò≠Á∏£": { t: 31.0, l: 68.0 },
            "Ëä±ËìÆÁ∏£": { t: 45.0, l: 60.0 },
            "Ëá∫Êù±Á∏£": { t: 66.0, l: 53.0 }
        };

        async function fetchWeather() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                
                if (data.success) {
                    citiesData = data.data;
                    renderMap();
                    loading.style.display = 'none';
                }
            } catch (err) {
                loading.innerText = "Error loading weather. Check backend!";
                console.error(err);
            }
        }

        function renderMap() {
            // Ê∏ÖÈô§ËàäÁöÑÊ¥ûÔºå‰ΩÜ‰øùÁïô SVG Âú∞Âúñ
            const oldHoles = board.querySelectorAll('.hole-container');
            oldHoles.forEach(h => h.remove());

            citiesData.forEach((city, index) => {
                const coords = coordinates[city.name] || { t: 50, l: 50 };

                const container = document.createElement('div');
                container.className = 'hole-container';
                container.dataset.index = index;
                
                container.style.top = coords.t + '%';
                container.style.left = coords.l + '%';

                container.innerHTML = `
                    <div class="mole" id="mole-${index}">
                        <div class="mole-info">
                            <strong>${city.minTemp}-${city.maxTemp}</strong>
                            <div>${city.condition}</div>
                            <div>‚òî ${city.pop}</div>
                        </div>
                    </div>
                    <div class="hole"></div>
                    <div class="city-label">${city.name}</div>
                `;

                container.addEventListener('click', (e) => {
                    e.stopPropagation();
                    whackMole(index);
                });

                board.appendChild(container);
            });
        }

        function whackMole(index) {
            clearTimeout(autoPlayTimeout);
            document.querySelectorAll('.hole-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.mole').forEach(el => el.classList.remove('bonked'));

            const allHoles = document.querySelectorAll('.hole-container');
            const target = Array.from(allHoles).find(h => h.dataset.index == index);

            if (target) {
                const targetMole = target.querySelector('.mole');
                target.classList.add('active');
                targetMole.classList.add('bonked');
                setTimeout(() => {
                    targetMole.classList.remove('bonked');
                }, 500);
            }
        }

        function hideAllMoles() {
            const activeMoles = document.querySelectorAll('.hole-container.active');
            if (activeMoles.length > 0) {
                activeMoles.forEach(el => el.classList.remove('active'));
                autoPlayTimeout = setTimeout(showRandomMole, 1000);
            }
        }

        function showRandomMole() {
            if (citiesData.length === 0) return;
            const randomIdx = Math.floor(Math.random() * citiesData.length);
            
            document.querySelectorAll('.hole-container').forEach(el => el.classList.remove('active'));
            
            const allHoles = document.querySelectorAll('.hole-container');
            const target = Array.from(allHoles).find(h => h.dataset.index == randomIdx);
            
            if(target) target.classList.add('active');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.hole-container')) {
                hideAllMoles();
            }
        });

        fetchWeather();
    </script>
</body>
</html>