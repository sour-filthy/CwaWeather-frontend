<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taiwan Weather Whack-a-Mole</title>
    <style>
        :root {
            --ground-color: #8da25d;
            --hole-color: #5d4037; /* æ·±å’–å•¡è‰²æ´ç©´ */
            --mole-color: #a1887f; /* ä¸€èˆ¬åœ°é¼ è‰² */
            --mole-happy: #ffd54f; /* å¿«æ¨‚è¢«é»åˆ°çš„é‡‘é»ƒè‰² */
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            
            /* --- 1. èƒŒæ™¯é»é»åœ–æ¡ˆ --- */
            background-color: #aaddff; /* åº•è‰² */
            background-image: radial-gradient(#ffffff 20%, transparent 20%), radial-gradient(#ffffff 20%, transparent 20%);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
        }

        h1 {
            color: #333; /* æ”¹æ·±è‰²å­—æ¯”è¼ƒæ¸…æ¥š */
            text-shadow: 2px 2px 0 #fff;
            margin: 20px 0;
            z-index: 10;
            text-align: center;
            font-size: 1.8rem;
        }

        /* --- åœ°åœ–å®¹å™¨ --- */
        .map-container {
            position: relative;
            width: 95%;
            max-width: 600px;
            aspect-ratio: 0.65;
            /* --- 2. ç²‰ç´…è‰²å°ç£åœ°åœ–è¼ªå»“ --- */
            /* ä½¿ç”¨ä¸€å¼µæœ‰ç¸£å¸‚ç•Œç·šçš„åœ°åœ– SVG */
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/f/f1/Taiwan_Republic_of_China_location_map.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            /* ä½¿ç”¨æ¿¾é¡æŠŠåœ°åœ–è®Šæˆç²‰ç´…è‰²èª¿ */
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3)) hue-rotate(300deg) saturate(3) brightness(1.2);
            margin-bottom: 50px;
        }

        /* --- æ¯å€‹åŸå¸‚çš„ä½ç½® --- */
        .hole-container {
            position: absolute;
            width: 60px;
            height: 60px;
            transform: translate(-50%, -50%);
            cursor: pointer;
        }

        /* è¢«é»åˆ°æ™‚å±¤ç´šæœ€é«˜ï¼Œä¸æœƒè¢«é®ä½ */
        .hole-container.active { z-index: 1000; }

        /* --- åœŸæ´ --- */
        .hole {
            width: 100%;
            height: 24px;
            background: var(--hole-color);
            border-radius: 50%;
            position: absolute;
            bottom: 15px; /* å¾€ä¸Šç§»ä¸€é» */
            box-shadow: 0 4px 6px rgba(0,0,0,0.5) inset;
            z-index: 1; /* åœ¨æœ€åº•å±¤ */
        }

        /* --- åŸå¸‚åç¨±æ¨™ç±¤ --- */
        .city-label {
            position: absolute;
            /* ç§»åˆ°æ´çš„ä¸Šæ–¹ */
            top: 10px;
            width: 80px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: #fff;
            font-weight: bold;
            font-size: 13px;
            text-shadow: 1px 1px 2px #333, -1px -1px 2px #333; /* åŠ å¼·é‚Šæ¡†è®“å­—æ›´æ¸…æ¥š */
            pointer-events: none;
            z-index: 3; /* åœ¨æ´ä¸Šé¢ */
        }

        /* --- åœ°é¼  --- */
        .mole {
            width: 44px;
            height: 50px;
            background: var(--mole-color);
            border-radius: 22px 22px 10px 10px;
            position: absolute;
            /* --- 3. å‡ºç¾åœ¨æ´çš„ä¸Šé¢ --- */
            bottom: 25px; /* èµ·å§‹ä½ç½®åœ¨æ´å£ */
            left: 50%;
            /* åˆå§‹ç‹€æ…‹ï¼šç¸®å°ä¸¦è—åœ¨å¾Œé¢ */
            transform: translateX(-50%) scale(0.1);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); /* å½ˆè·³æ•ˆæœ */
            z-index: 2; /* åœ¨æ´å’Œæ¨™ç±¤çš„ä¸­é–“ */
            display: flex;
            justify-content: center;
        }

        /* åœ°é¼ çš„è‡‰ */
        .mole::before { /* é¼»å­ */
            content: ''; width: 14px; height: 9px; background: #ffccbc;
            border-radius: 50%; position: absolute; top: 22px;
        }
        .mole::after { /* çœ¼ç› (é è¨­) */
            content: ''; width: 5px; height: 5px; background: #333;
            border-radius: 50%; position: absolute; top: 15px; left: 12px;
            box-shadow: 14px 0 0 #333;
        }

        /* --- 4. å¿«æ¨‚è¢«é»åˆ°çš„ç‹€æ…‹ --- */
        .mole.bonked { 
            background: var(--mole-happy); /* è®Šé‡‘é»ƒè‰² */
        }
        .mole.bonked::after {
            /* æ”¹æˆå¿«æ¨‚çš„è¡¨æƒ… ^ ^ */
            content: '^ ^';
            background: transparent; box-shadow: none;
            font-size: 12px; font-weight: bold; top: 12px; left: 50%;
            transform: translateX(-50%); /* å±…ä¸­ */
            color: #5d4037; letter-spacing: 4px;
        }

        /* å¤©æ°£è³‡è¨Šç‰Œ */
        .mole-info {
            background: white;
            padding: 5px 8px;
            border-radius: 8px;
            text-align: center;
            font-size: 12px;
            border: 3px solid var(--mole-happy); /* é‚Šæ¡†è·Ÿè‘—å¿«æ¨‚è‰² */
            position: absolute;
            top: -65px;
            width: 90px;
            left: 50%;
            transform: translateX(-50%) scale(0.8);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s 0.1s; /* ç¨å¾®å»¶é²å‡ºç¾ */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .mole-info strong { color: #d84315; font-size: 1.1em; display: block; margin-bottom: 2px;}

        /* --- è¢«é»åˆ°æ™‚çš„å‹•ç•« --- */
        .hole-container.active .mole { 
            /* å½ˆå‡ºä¾†ä¸¦è®Šå›åŸå°ºå¯¸ */
            transform: translateX(-50%) scale(1); 
            opacity: 1;
        }
        .hole-container.active .mole-info { 
            opacity: 1; 
            transform: translateX(-50%) scale(1);
        }

        /* --- ğŸ“± æ‰‹æ©Ÿç‰ˆ RWD --- */
        @media (max-width: 600px) {
            .hole-container { width: 36px; height: 36px; }
            .hole { height: 14px; bottom: 8px; }
            
            .city-label {
                font-size: 10px;
                top: 4px;
                text-shadow: 1px 1px 1px #333, -1px -1px 1px #333;
            }

            .mole {
                width: 28px; height: 34px; bottom: 14px;
                border-radius: 14px 14px 6px 6px;
            }
            .mole::before { width: 8px; height: 6px; top: 14px; } /* é¼»å­ */
            .mole::after { width: 3px; height: 3px; top: 10px; left: 8px; box-shadow: 9px 0 0 #333; } /* çœ¼ç› */
            .mole.bonked::after { font-size: 9px; top: 8px; letter-spacing: 2px; } /* å¿«æ¨‚çœ¼ */

            .mole-info {
                top: -55px; width: 75px; font-size: 10px; padding: 4px;
            }
        }
    </style>
</head>
<body>

    <h1>ğŸŒ§ï¸ Weather Whack-a-Mole ğŸŒ¤ï¸</h1>
    <div id="loading">Scouting for moles...</div>
    <div id="game-board" class="game-board"></div>

    <script>
        // âš ï¸ CHECK THIS LINK: Must be HTTPS
        const API_URL = 'https://hex-final.zeabur.app/api/weather'; 
        
        const board = document.getElementById('game-board');
        const loading = document.getElementById('loading');
        let citiesData = [];
        let autoPlayTimeout = null;

        // ğŸ—ºï¸ COORDINATES: Maps city names to % positions (Top, Left)
        const coordinates = {
            "åŸºéš†å¸‚": { t: 5, l: 72 },
            "è‡ºåŒ—å¸‚": { t: 8, l: 68 },
            "æ–°åŒ—å¸‚": { t: 12, l: 70 },
            "æ¡ƒåœ’å¸‚": { t: 10, l: 55 },
            "æ–°ç«¹å¸‚": { t: 16, l: 50 },
            "æ–°ç«¹ç¸£": { t: 18, l: 58 },
            "è‹—æ —ç¸£": { t: 22, l: 48 },
            "è‡ºä¸­å¸‚": { t: 30, l: 42 },
            "å½°åŒ–ç¸£": { t: 36, l: 38 },
            "å—æŠ•ç¸£": { t: 38, l: 55 },
            "é›²æ—ç¸£": { t: 45, l: 35 },
            "å˜‰ç¾©å¸‚": { t: 50, l: 38 },
            "å˜‰ç¾©ç¸£": { t: 50, l: 45 },
            "è‡ºå—å¸‚": { t: 60, l: 32 },
            "é«˜é›„å¸‚": { t: 70, l: 35 },
            "å±æ±ç¸£": { t: 80, l: 45 },
            "å®œè˜­ç¸£": { t: 20, l: 80 },
            "èŠ±è“®ç¸£": { t: 40, l: 75 },
            "è‡ºæ±ç¸£": { t: 70, l: 65 },
            "æ¾æ¹–ç¸£": { t: 45, l: 10 },
            "é‡‘é–€ç¸£": { t: 15, l: 5 },
            "é€£æ±Ÿç¸£": { t: 2, l: 30 }
        };

        async function fetchWeather() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                
                if (data.success) {
                    citiesData = data.data;
                    renderMap();
                    loading.style.display = 'none';
                }
            } catch (err) {
                loading.innerText = "Error loading weather. Check backend!";
                console.error(err);
            }
        }

        function renderMap() {
            board.className = 'map-container'; // Ensures CSS class matches
            board.innerHTML = '';

            citiesData.forEach((city, index) => {
                // Use coordinate or default to center if missing
                const coords = coordinates[city.name] || { t: 50, l: 50 };

                const container = document.createElement('div');
                container.className = 'hole-container';
                container.dataset.index = index;
                
                // Set Position
                container.style.top = coords.t + '%';
                container.style.left = coords.l + '%';

                container.innerHTML = `
                    <div class="mole" id="mole-${index}">
                        <div class="mole-info">
                            <strong>${city.minTemp}-${city.maxTemp}</strong>
                            <div>${city.condition}</div>
                            <div>â˜” ${city.pop}</div>
                        </div>
                    </div>
                    <div class="hole"></div>
                    <div class="city-label">${city.name}</div>
                `;

                // Click Event
                container.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent hitting the background
                    whackMole(index);
                });

                board.appendChild(container);
            });
        }

        function whackMole(index) {
            clearTimeout(autoPlayTimeout); // Pause auto-play
            
            // 1. Reset all other moles
            document.querySelectorAll('.hole-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.mole').forEach(el => el.classList.remove('bonked'));

            // 2. Activate the clicked mole
            const targetContainer = board.children[index];
            const targetMole = targetContainer.querySelector('.mole');

            if (targetContainer) {
                targetContainer.classList.add('active'); // Pop up
                targetMole.classList.add('bonked');      // Turn red
                
                // Remove red color after 0.5s (but keep mole up)
                setTimeout(() => {
                    targetMole.classList.remove('bonked');
                }, 500);
            }
        }

        function hideAllMoles() {
            const activeMoles = document.querySelectorAll('.hole-container.active');
            if (activeMoles.length > 0) {
                activeMoles.forEach(el => el.classList.remove('active'));
                
                // Restart the "Game" (Random mole pops up)
                autoPlayTimeout = setTimeout(showRandomMole, 1000);
            }
        }

        function showRandomMole() {
            if (citiesData.length === 0) return;
            
            const randomIdx = Math.floor(Math.random() * citiesData.length);
            
            // Reset others
            document.querySelectorAll('.hole-container').forEach(el => el.classList.remove('active'));
            
            // Pop up random mole (without 'bonked' red color)
            const target = board.children[randomIdx];
            if(target) target.classList.add('active');
        }

        // Click background to hide mole
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.hole-container')) {
                hideAllMoles();
            }
        });

        // Start
        fetchWeather();
    </script>
</body>
</html>